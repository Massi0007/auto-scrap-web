{% extends 'base.html' %}

{% block title %}{{ annonce['titre_annonce'] }} - Analyse{% endblock %}

{% block content %}
{# --- CALCULS JINJA ROBUSTES --- #}
{% set prix_total = annonce.prix_max_frais_inclus | default(0) | float %}
{% set marge = annonce.marge_estimee_min | default(0) | float %}
{% set roi = 0 %}
{% if prix_total > 0 %}
    {% set roi = (marge / prix_total) * 100 %}
{% endif %}

<div class="container py-4 mb-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">{{ annonce['titre_annonce'] }}</h2>
            <div class="text-muted">
                Lot n°{{ annonce['num_lot'] }} • <i class="bi bi-geo-alt"></i> {{ annonce['ville'] }} • {{ annonce['date_debut'] | format_datetime }}
            </div>
        </div>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour
        </a>
    </div>

    <div class="row g-4">
        <!-- COLONNE GAUCHE : VISUELS & INFOS -->
        <div class="col-lg-7">
            <!-- Image Principale -->
            <div class="card border-0 shadow-sm overflow-hidden mb-4">
                <img src="{{ annonce['lien_image_vehicule'] }}" class="w-100" style="height: 450px; object-fit: cover;" alt="Vehicule" onerror="this.src='https://placehold.co/800x500?text=Image+Manquante';">
            </div>

            <!-- Fiche Technique -->
            <div class="card mb-4">
                <div class="card-header bg-white fw-bold"><i class="bi bi-car-front-fill me-2"></i>Caractéristiques</div>
                <div class="card-body">
                    <div class="row row-cols-2 row-cols-md-3 g-3">
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Marque</small> <strong>{{ annonce.marque_annonce }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Modèle</small> <strong>{{ annonce.modele_annonce }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Année</small> <strong>{{ annonce.annee }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">KM</small> <strong>{{ annonce.kilometrage | format_number }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Énergie</small> <strong>{{ annonce.energie }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Boîte</small> <strong>{{ annonce.boite_de_vitesse }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Mise en Circ.</small> <strong>{{ annonce.date_mise_en_service }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Vendeur</small> <strong class="text-truncate d-block">{{ annonce.maison_vente }}</strong></div>
                    </div>
                </div>
            </div>

            <!-- GALERIE PHOTOS COMPLÈTE (Restaurée) -->
            {% if annonce.images_all %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white fw-bold py-3">
                    <i class="bi bi-images me-2"></i> Galerie Photos
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        {# On sépare les URLS par le séparateur ' | ' #}
                        {% set gallery = annonce.images_all.split(' | ') %}
                        {% for img_url in gallery %}
                            {# Petite sécurité pour ne pas afficher d'images vides #}
                            {% if 'http' in img_url %}
                            <div class="col-6 col-md-4 col-lg-3">
                                <a href="{{ img_url }}" target="_blank">
                                    <img src="{{ img_url }}" class="img-fluid rounded border w-100" style="height: 120px; object-fit: cover;" loading="lazy" alt="Photo galerie">
                                </a>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="alert alert-light border">
                <strong>Description :</strong><br>
                <small class="text-muted" style="white-space: pre-line;">{{ annonce.description }}</small>
            </div>
        </div>

        <!-- COLONNE DROITE : ANALYSE FINANCIÈRE (Sticky) -->
        <div class="col-lg-5">
            <div style="position: sticky; top: 1rem;">
                <!-- Box KPI Principaux -->
                <div class="card border-primary mb-4 shadow-sm">
                    <div class="card-body text-center">
                        <h6 class="text-uppercase text-muted fw-bold mb-3">Analyse de Rentabilité</h6>
                        
                        <div class="row align-items-center">
                            <div class="col-6 border-end">
                                <small class="text-muted">Coût Total Est.</small>
                                <div class="fs-4 fw-bold text-dark">{{ prix_total | format_number }} €</div>
                                <small class="text-muted d-block" style="font-size: 0.7rem;">(Frais Inclus)</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Marge Potentielle</small>
                                <div class="fs-3 fw-bold {% if roi > 15 %}text-success{% else %}text-primary{% endif %}">
                                    +{{ marge | format_number }} €
                                </div>
                                <span class="badge {% if roi > 15 %}bg-success{% else %}bg-warning text-dark{% endif %}">
                                    ROI: {{ roi | format_percent }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GRAPHIQUE CHART.JS -->
                <div class="card mb-4">
                    <div class="card-header bg-white fw-bold">Positionnement Marché</div>
                    <div class="card-body">
                        <canvas id="marketChart" height="200"></canvas>
                        <div class="text-center mt-3 small text-muted">
                            Cote estimée : <strong>{{ (prix_total + marge) | format_number }} €</strong>
                        </div>
                    </div>
                </div>

                <!-- Liens d'action -->
                <div class="d-grid gap-2">
                    <a href="{{ annonce['url_web'] }}" target="_blank" class="btn btn-primary fw-bold p-3">
                        <i class="bi bi-hammer me-2"></i> Accéder à l'enchère
                    </a>
                    <a href="{{ build_leboncoin_url(annonce) }}" target="_blank" class="btn btn-warning text-white fw-bold">
                        <i class="bi bi-search me-2"></i> Vérifier sur LeBonCoin
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Injection sécurisée des données
        const coutTotal = {{ prix_total }};
        const marge = {{ marge }};
        let coteMarche = coutTotal + marge;
        
        // Tentative d'utilisation d'une cote précise si dispo
        {% if annonce.market_avg %}
            coteMarche = {{ annonce.market_avg | float }};
        {% endif %}

        const ctx = document.getElementById('marketChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Coût Achat', 'Cote Marché'],
                datasets: [{
                    label: 'Montant (€)',
                    data: [coutTotal, coteMarche],
                    backgroundColor: [
                        'rgba(37, 99, 235, 0.7)', // Bleu Primary
                        'rgba(16, 185, 129, 0.7)'  // Vert Success
                    ],
                    borderColor: [
                        'rgba(37, 99, 235, 1)',
                        'rgba(16, 185, 129, 1)'
                    ],
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.raw.toLocaleString('fr-FR') + ' €';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { return value + ' €'; }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}