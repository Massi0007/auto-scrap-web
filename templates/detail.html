{% extends 'base.html' %}

{% block title %}{{ annonce['titre_annonce'] }} - Analyse{% endblock %}

{% block content %}
{# --- CALCULS JINJA ROBUSTES --- #}
{% set prix_total = annonce.prix_max_frais_inclus | default(0) | float %}
{% set marge = annonce.marge_estimee_min | default(0) | float %}
{% set roi = 0 %}
{% if prix_total > 0 %}
    {% set roi = (marge / prix_total) * 100 %}
{% endif %}
{# Calcul de la valeur marché estimée (Investment + Margin = Market Price) #}
{# Si prix_total est 0, marge contient la valeur marché (selon la logique SQL) #}
{% set valeur_marche = prix_total + marge %}

<div class="container py-4 mb-5">
    <!-- Header avec Info Vente -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <!-- Bandeau Maison de Vente / Date -->
                <div class="mb-2 d-flex align-items-center flex-wrap gap-2">
                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-2 rounded-pill fw-normal">
                        <i class="bi bi-building me-1"></i> {{ annonce['maison_vente'] }}
                    </span>
                    <span class="badge bg-light text-dark border px-3 py-2 rounded-pill fw-normal">
                        <i class="bi bi-calendar-event me-1"></i> {{ annonce['date_debut'] | format_datetime('%d/%m/%Y à %H:%M') }}
                    </span>
                    <span class="badge bg-light text-secondary border px-3 py-2 rounded-pill fw-normal">
                         <i class="bi bi-geo-alt me-1"></i> {{ annonce['ville'] }}
                    </span>
                </div>
                <h2 class="fw-bold mb-0 text-dark">{{ annonce['titre_annonce'] }}</h2>
                <div class="text-muted mt-1 small">
                    Lot n°{{ annonce['num_lot'] }} • Mise en circulation : {{ annonce['date_mise_en_service'] }}
                </div>
            </div>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Retour
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- COLONNE GAUCHE : VISUELS & INFOS -->
        <div class="col-lg-7">
            <!-- Image Principale -->
            <div class="card border-0 shadow-sm overflow-hidden mb-4">
                <img src="{{ annonce['lien_image_vehicule'] }}" class="w-100" style="height: 450px; object-fit: cover;" alt="Vehicule" onerror="this.src='https://placehold.co/800x500?text=Image+Manquante';">
            </div>

            <!-- Fiche Technique -->
            <div class="card mb-4 border-light shadow-sm">
                <div class="card-header bg-white fw-bold py-3"><i class="bi bi-car-front-fill me-2"></i>Caractéristiques</div>
                <div class="card-body">
                    <div class="row row-cols-2 row-cols-md-3 g-3">
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Marque</small> <strong>{{ annonce.marque_annonce }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Modèle</small> <strong>{{ annonce.modele_annonce }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Année</small> <strong>{{ annonce.annee }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">KM</small> <strong>{{ annonce.kilometrage | format_number }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Énergie</small> <strong>{{ annonce.energie }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Boîte</small> <strong>{{ annonce.boite_de_vitesse }}</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Puissance</small> <strong>{{ annonce.puissance_fiscale }} CV</strong></div>
                        <div><small class="text-muted d-block text-uppercase" style="font-size:0.7rem">Carrosserie</small> <strong>{{ annonce.carrosserie }}</strong></div>
                    </div>
                </div>
            </div>

            <!-- GALERIE PHOTOS COMPLÈTE -->
            {% if annonce.images_all %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white fw-bold py-3">
                    <i class="bi bi-images me-2"></i> Galerie Photos
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        {% set gallery = annonce.images_all.split(' | ') %}
                        {% for img_url in gallery %}
                            {% if 'http' in img_url %}
                            <div class="col-6 col-md-4 col-lg-3">
                                <a href="{{ img_url }}" target="_blank">
                                    <img src="{{ img_url }}" class="img-fluid rounded border w-100" style="height: 120px; object-fit: cover;" loading="lazy" alt="Photo galerie">
                                </a>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="alert alert-light border">
                <strong>Description :</strong><br>
                <small class="text-muted" style="white-space: pre-line;">{{ annonce.description }}</small>
            </div>
        </div>

        <!-- COLONNE DROITE : ANALYSE FINANCIÈRE (Sticky) -->
        <div class="col-lg-5">
            <div style="position: sticky; top: 6rem;">
                <!-- Box KPI Principaux -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-primary bg-opacity-10 text-primary fw-bold text-center py-3">
                        <i class="bi bi-calculator"></i> Analyse de Rentabilité
                    </div>
                    <div class="card-body text-center p-4">
                        <!-- Affichage Estimation Marché (Toujours visible) -->
                        <div class="mb-4">
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Estimation Marché (Revente)</small>
                            <div class="fs-2 fw-bold text-success">{{ valeur_marche | format_number }} €</div>
                        </div>

                        {% if prix_total > 0 %}
                            <hr class="my-3 opacity-10">
                            <div class="row align-items-center">
                                <div class="col-6 border-end">
                                    <small class="text-muted" style="font-size: 0.7rem;">Coût Achat Est.</small>
                                    <div class="fw-bold text-dark">{{ prix_total | format_number }} €</div>
                                    <small class="text-muted d-block" style="font-size: 0.65rem;">(Frais Inclus)</small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted" style="font-size: 0.7rem;">Marge Pot.</small>
                                    <div class="fw-bold {% if roi > 0 %}text-success{% else %}text-danger{% endif %}">
                                        {% if marge > 0 %}+{% endif %}{{ marge | format_number }} €
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <span class="badge {% if roi > 15 %}bg-success{% else %}bg-warning text-dark{% endif %} rounded-pill">
                                    ROI: {{ roi | format_percent }}
                                </span>
                            </div>
                        {% else %}
                            <div class="alert alert-warning border-warning bg-warning bg-opacity-10 py-2 mb-0 small">
                                <i class="bi bi-info-circle me-1"></i> Mise à prix non communiquée.<br>
                                Calcul de marge impossible.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- GRAPHIQUE CHART.JS -->
                <!-- Affichage conditionnel modifié : Toujours afficher le graph si on a une estimation marché, même sans prix achat -->
                {% if valeur_marche > 0 %}
                <div class="card mb-4 border-light shadow-sm">
                    <div class="card-header bg-white fw-bold">Positionnement Marché</div>
                    <div class="card-body">
                        <canvas id="marketChart" height="200"></canvas>
                        <div class="text-center mt-3 small text-muted">
                            Cote estimée (Revente rapide) : <strong>{{ valeur_marche | format_number }} €</strong>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Liens d'action -->
                <div class="d-grid gap-2">
                    <a href="{{ annonce['url_web'] }}" target="_blank" class="btn btn-primary fw-bold p-3 shadow-sm">
                        <i class="bi bi-hammer me-2"></i> Accéder à l'enchère
                    </a>
                    <a href="{{ build_leboncoin_url(annonce) }}" target="_blank" class="btn btn-warning text-dark fw-bold shadow-sm">
                        <i class="bi bi-search me-2"></i> Vérifier sur LeBonCoin
                    </a>
                </div>
                
                <!-- Remarques IA -->
                {% if annonce.remarque_importante %}
                <div class="alert alert-info border-info mt-4 mb-0 shadow-sm d-flex align-items-start">
                    <i class="bi bi-robot me-3 fs-4"></i>
                    <div>
                        <strong class="d-block mb-1">Analyse IA :</strong>
                        {{ annonce.remarque_importante }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if valeur_marche > 0 %}
            // Injection sécurisée des données
            const coutTotal = {{ prix_total }};
            // Si le coût est 0, on garde 0 pour le graph
            
            let coteMarche = {{ valeur_marche }};
            
            // Tentative d'utilisation d'une cote précise si dispo (legacy)
            {% if annonce.market_avg %}
                coteMarche = {{ annonce.market_avg | float }};
            {% endif %}

            const ctx = document.getElementById('marketChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Coût Achat', 'Cote Marché'],
                    datasets: [{
                        label: 'Montant (€)',
                        data: [coutTotal, coteMarche],
                        backgroundColor: [
                            'rgba(37, 99, 235, 0.7)', // Bleu Primary
                            'rgba(16, 185, 129, 0.7)'  // Vert Success
                        ],
                        borderColor: [
                            'rgba(37, 99, 235, 1)',
                            'rgba(16, 185, 129, 1)'
                        ],
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.raw.toLocaleString('fr-FR') + ' €';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { return value + ' €'; }
                            }
                        }
                    }
                }
            });
        {% endif %}
    });
</script>
{% endblock %}