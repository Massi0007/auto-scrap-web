{% extends 'base.html' %}

{% block title %}Ventes à Venir - AutoEnchères Pro{% endblock %}

{% block content %}
<style>
    /* --- CSS RESPONSIVE & SIDEBAR --- */
    @media (min-width: 992px) {
        .sidebar-wrapper {
            position: sticky; 
            top: 5rem;
            height: calc(100vh - 6rem);
            overflow-y: auto;
            padding-right: 10px;
        }
        .offcanvas-header { display: none; }
    }

    @media (max-width: 991.98px) {
        .sidebar-wrapper { height: 100%; overflow-y: auto; }
        .mobile-filter-btn { position: sticky; top: 70px; z-index: 99; margin-bottom: 1rem; }
    }

    /* Scrollbar fine */
    .sidebar-wrapper::-webkit-scrollbar, 
    .filter-list-scroll::-webkit-scrollbar { width: 4px; }
    .sidebar-wrapper::-webkit-scrollbar-thumb, 
    .filter-list-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

    /* Styles Filtres */
    .filter-group { background: #fff; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 0.75rem; }
    .filter-title { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 0.5rem; letter-spacing: 0.5px; }
    .filter-list-scroll { max-height: 150px; overflow-y: auto; }
    
    /* Petits liens d'action (Tout/Rien) */
    .filter-action-link { font-size: 0.65rem; text-decoration: none; cursor: pointer; color: #2563eb; }
    .filter-action-link:hover { text-decoration: underline; }

    /* Carte Véhicule */
    .card-vehicule { transition: all 0.2s; border: 1px solid #f1f5f9; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .card-vehicule:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        border-color: #cbd5e1;
        z-index: 10;
    }
    .img-container { position: relative; height: 190px; overflow: hidden; background: #f8fafc; border-bottom: 1px solid #f1f5f9; }
    .img-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .card-vehicule:hover .img-container img { transform: scale(1.03); }
    
    .stat-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.25rem; }
    .progress-thin { height: 4px; border-radius: 2px; background-color: #f1f5f9; }
    .info-tag { font-size: 0.7rem; background: #f8fafc; color: #64748b; padding: 2px 6px; border-radius: 4px; margin-right: 4px; display: inline-block; margin-bottom: 4px; border: 1px solid #e2e8f0; }

    /* Badges ROI */
    .badge-roi-high { background-color: white; color: #059669; border: 1px solid #a7f3d0; }
    .badge-roi-med { background-color: white; color: #d97706; border: 1px solid #fcd34d; }
</style>

<div class="row g-0">
    
    <!-- BOUTON FILTRE MOBILE -->
    <div class="col-12 d-lg-none px-3 mobile-filter-btn">
        <button class="btn btn-dark w-100 shadow-sm fw-bold" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarFilters" aria-controls="sidebarFilters">
            <i class="bi bi-funnel"></i> Filtres
        </button>
    </div>

    <!-- SIDEBAR / OFFCANVAS -->
    <aside class="col-lg-3 col-xl-2 border-end bg-white">
        <div class="offcanvas-lg offcanvas-start bg-white h-100" tabindex="-1" id="sidebarFilters" aria-labelledby="sidebarFiltersLabel">
            
            <div class="offcanvas-header border-bottom">
                <h5 class="offcanvas-title fw-bold" id="sidebarFiltersLabel">Filtres</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#sidebarFilters" aria-label="Close"></button>
            </div>

            <div class="offcanvas-body p-0">
                <div class="sidebar-wrapper ps-3 py-3 pe-3">
                    <form method="POST" action="{{ url_for('index') }}" id="filterForm">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0 text-dark d-none d-lg-block"><i class="bi bi-filter"></i> Filtres</h6>
                            <a href="{{ url_for('reset_filters') }}" class="text-secondary small text-decoration-none"><i class="bi bi-arrow-counterclockwise"></i> Reset</a>
                        </div>

                        <!-- Recherche Texte -->
                        <div class="mb-3">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-search"></i></span>
                                <input type="text" name="keyword" class="form-control border-start-0 bg-white" value="{{ f_keyword }}" placeholder="Rechercher...">
                            </div>
                        </div>

                        <!-- DATES DE VENTE -->
                        <div class="filter-group">
                            <div class="filter-title">Date de vente</div>
                            <div class="row g-1">
                                <div class="col-6">
                                    <label class="form-label small text-muted mb-0" style="font-size: 0.65rem;">Du</label>
                                    <input type="date" name="date_min" class="form-control form-control-sm text-secondary" value="{{ f_date_min }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label small text-muted mb-0" style="font-size: 0.65rem;">Au</label>
                                    <input type="date" name="date_max" class="form-control form-control-sm text-secondary" value="{{ f_date_max }}">
                                </div>
                            </div>
                        </div>

                        <!-- FILTRE PRIX ESTIMATION (NOUVEAU) -->
                        <div class="filter-group">
                            <div class="filter-title">Prix Estimation</div>
                            <div class="btn-group w-100" role="group" aria-label="Filtre Prix">
                                <input type="radio" class="btn-check" name="has_price" id="price-all" value="all" {% if f_has_price == 'all' %}checked{% endif %} onchange="this.form.submit()">
                                <label class="btn btn-outline-secondary btn-sm" for="price-all">Tous</label>
                              
                                <input type="radio" class="btn-check" name="has_price" id="price-yes" value="yes" {% if f_has_price == 'yes' %}checked{% endif %} onchange="this.form.submit()">
                                <label class="btn btn-outline-secondary btn-sm" for="price-yes">Avec</label>
                              
                                <input type="radio" class="btn-check" name="has_price" id="price-no" value="no" {% if f_has_price == 'no' %}checked{% endif %} onchange="this.form.submit()">
                                <label class="btn btn-outline-secondary btn-sm" for="price-no">Sans</label>
                            </div>
                        </div>

                        <!-- MAISONS DE VENTE -->
                        <div class="filter-group">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="filter-title mb-0">Maisons de Vente</div>
                                <div>
                                    <span class="filter-action-link me-1" onclick="toggleCheckboxes('maisonList', true)">Tout</span>
                                    <span class="text-muted" style="font-size: 0.65rem;">/</span>
                                    <span class="filter-action-link ms-1" onclick="toggleCheckboxes('maisonList', false)">Rien</span>
                                </div>
                            </div>
                            <div class="filter-list-scroll mt-2" id="maisonList">
                                {% for m in maisons %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="maison_vente" value="{{ m }}" id="house-{{ loop.index }}" {% if m in f_maisons %}checked{% endif %}>
                                    <label class="form-check-label small text-truncate w-100 text-secondary" for="house-{{ loop.index }}">{{ m }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Rentabilité & Tri -->
                        <div class="filter-group">
                            <div class="filter-title">Rentabilité & Tri</div>
                            <select name="sort" class="form-select form-select-sm mb-2 text-secondary" onchange="this.form.submit()">
                                <option value="roi_desc" {% if f_sort == 'roi_desc' %}selected{% endif %}>Rentabilité (%)</option>
                                <option value="marge_desc" {% if f_sort == 'marge_desc' %}selected{% endif %}>Marge (€)</option>
                                <option value="date_vente_asc" {% if f_sort == 'date_vente_asc' %}selected{% endif %}>Date (Proche)</option>
                                <option value="prix_asc" {% if f_sort == 'prix_asc' %}selected{% endif %}>Prix (Croissant)</option>
                            </select>
                            <div class="row g-1">
                                <div class="col-6">
                                    <input type="number" name="marge_min" class="form-control form-control-sm" value="{{ f_marge_min }}" placeholder="Marge Min">
                                </div>
                                <div class="col-6">
                                    <input type="number" name="prix_max" class="form-control form-control-sm" value="{{ f_prix_max }}" placeholder="Budget Max">
                                </div>
                            </div>
                        </div>

                        <!-- MARQUES -->
                        <div class="filter-group">
                            <div class="filter-title">Marques</div>
                            <input type="text" id="marqueSearch" class="form-control form-control-sm mb-2" placeholder="Filtrer..." style="font-size: 0.75rem;">
                            <div class="filter-list-scroll" id="marqueList">
                                {% for m in marques %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="marque" value="{{ m }}" id="m-{{ loop.index }}" {% if m in f_marques %}checked{% endif %}>
                                    <label class="form-check-label small text-truncate w-100 text-secondary" for="m-{{ loop.index }}">{{ m }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- BOITES -->
                        <div class="filter-group">
                            <div class="filter-title">Boîte de vitesse</div>
                            <div class="filter-list-scroll">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="boite" value="None" id="b-none" {% if 'None' in f_boites %}checked{% endif %}>
                                    <label class="form-check-label small text-muted fst-italic" for="b-none">Non spécifié</label>
                                </div>
                                {% for b in boites %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="boite" value="{{ b }}" id="b-{{ loop.index }}" {% if b in f_boites %}checked{% endif %}>
                                    <label class="form-check-label small text-secondary" for="b-{{ loop.index }}">{{ b }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- ENERGIE -->
                        <div class="filter-group">
                            <div class="filter-title">Énergie</div>
                            <div class="filter-list-scroll" style="max-height: 100px;">
                                {% for e in energies %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="energie" value="{{ e }}" id="e-{{ loop.index }}" {% if e in f_energies %}checked{% endif %}>
                                    <label class="form-check-label small text-secondary" for="e-{{ loop.index }}">{{ e }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- KM & ANNEE -->
                        <div class="filter-group">
                            <div class="filter-title">Compteur & Année</div>
                            <div class="mb-2">
                                <input type="number" name="km_max" class="form-control form-control-sm" value="{{ f_km_max }}" placeholder="KM Max">
                            </div>
                            <div class="row g-1">
                                <div class="col-6">
                                    <input type="number" name="annee_min" class="form-control form-control-sm" value="{{ f_annee_min }}" placeholder="An Min">
                                </div>
                                <div class="col-6">
                                    <input type="number" name="annee_max" class="form-control form-control-sm" value="{{ f_annee_max }}" placeholder="An Max">
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mt-3 mb-5">
                            <button type="submit" class="btn btn-dark btn-sm fw-bold shadow-sm">
                                Appliquer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="col-12 col-lg-9 col-xl-10 bg-light">
        <div class="p-3 p-md-4">
            <!-- Info Bar -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 bg-white p-3 rounded shadow-sm border border-light">
                <div class="mb-3 mb-md-0">
                    <h5 class="fw-bold mb-0 text-dark">{{ total_annonces }} <span class="text-muted fs-6 fw-normal">résultats</span></h5>
                    
                    <!-- Badges Filtres Actifs -->
                    <div class="mt-1">
                        {% if f_has_price == 'yes' %} <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">Avec Prix</span>
                        {% elif f_has_price == 'no' %} <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25">Sans Prix</span> {% endif %}
                        
                        {% if f_marques %}
                            {% for m in f_marques %} <span class="badge bg-light text-dark border">{{ m }}</span> {% endfor %}
                        {% endif %}
                        {% if f_maisons %}
                            {% for m in f_maisons %} <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25">{{ m }}</span> {% endfor %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Pagination -->
                {% if total_pages > 1 %}
                <nav>
                    <ul class="pagination pagination-sm m-0">
                        <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                            <a class="page-link border-0 bg-transparent text-secondary" href="{{ url_for('index', page=current_page - 1) }}"><i class="bi bi-chevron-left"></i></a>
                        </li>
                        <li class="page-item active"><span class="page-link border-0 fw-bold bg-dark text-white rounded-circle mx-1" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">{{ current_page }}</span></li>
                        <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                            <a class="page-link border-0 bg-transparent text-secondary" href="{{ url_for('index', page=current_page + 1) }}"><i class="bi bi-chevron-right"></i></a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
            </div>

            <!-- GRILLE CARTES -->
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-3 g-xl-4">
                {% for a in annonces %}
                    {# Calcul ROI #}
                    {% set prix_total = a.prix_max_frais_inclus | default(0) | float %}
                    {% set marge = a.marge_estimee_min | default(0) | float %}
                    {% set roi = 0 %}
                    {% if prix_total > 0 %}
                        {% set roi = (marge / prix_total) * 100 %}
                    {% endif %}

                <div class="col">
                    <div class="card h-100 card-vehicule rounded-3 overflow-hidden border-0">
                        <a href="{{ url_for('detail', annonce_id=a.id) }}" class="text-decoration-none text-dark">
                            <div class="img-container">
                                <img src="{{ a.lien_image_vehicule }}" loading="lazy" onerror="this.src='https://placehold.co/400x300?text=Image+Non+Dispo';">
                                
                                {% if roi >= 20 and prix_total > 0 %}
                                    <span class="position-absolute top-0 start-0 badge badge-roi-high m-2 shadow-sm rounded-1 text-uppercase" style="letter-spacing: 0.5px; font-size: 0.65rem;">
                                        <i class="bi bi-arrow-up-right"></i> Top {{ roi | format_percent }}
                                    </span>
                                {% elif roi >= 10 and prix_total > 0 %}
                                    <span class="position-absolute top-0 start-0 badge badge-roi-med m-2 shadow-sm rounded-1 text-uppercase" style="letter-spacing: 0.5px; font-size: 0.65rem;">
                                        {{ roi | format_percent }}
                                    </span>
                                {% endif %}
                                
                                <span class="position-absolute bottom-0 end-0 badge bg-dark bg-opacity-75 backdrop-blur m-2 small fw-normal">
                                    {{ a.maison_vente }}
                                </span>
                            </div>

                            <div class="card-body p-3 d-flex flex-column">
                                <h6 class="card-title fw-bold text-truncate mb-2 text-dark" title="{{ a.titre_annonce }}">
                                    {{ a.titre_annonce }}
                                </h6>
                                
                                <div class="mb-3">
                                    <div>
                                        <span class="info-tag">{{ a.annee }}</span>
                                        <span class="info-tag">{{ a.kilometrage | format_number }} km</span>
                                    </div>
                                    <div>
                                        <span class="info-tag text-truncate" style="max-width: 80px;">{{ a.energie }}</span>
                                        {% if a.boite_de_vitesse %}
                                            <span class="info-tag">{{ a.boite_de_vitesse }}</span>
                                        {% endif %}
                                    </div>
                                    {% if a.ville %}
                                    <div class="small text-muted mt-1 text-truncate">
                                        {{ a.ville }}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="mt-auto pt-2 border-top border-light">
                                    {% if prix_total > 0 %}
                                        <div class="stat-row align-items-end">
                                            <div>
                                                <div class="text-muted" style="font-size: 0.7rem;">Investissement</div>
                                                <div class="fw-bold text-dark">{{ prix_total | format_number }} €</div>
                                            </div>
                                            <div class="text-end">
                                                <div class="text-muted" style="font-size: 0.7rem;">Marge</div>
                                                <div class="fw-bold {% if roi > 10 %}text-success{% elif roi > 0 %}text-dark{% else %}text-muted{% endif %}">
                                                    {% if marge > 0 %}+{% endif %}{{ marge | format_number }} €
                                                </div>
                                            </div>
                                        </div>
                                        <div class="progress progress-thin mt-2 bg-light">
                                            {% set width = roi if roi < 100 else 100 %}
                                            {% set width = width if width > 0 else 5 %}
                                            <div class="progress-bar {% if roi > 15 %}bg-success{% elif roi > 5 %}bg-warning{% else %}bg-secondary{% endif %} opacity-75" 
                                                 role="progressbar" 
                                                 style="width: {{ width }}%"></div>
                                        </div>
                                    {% else %}
                                        <div class="d-flex align-items-center justify-content-center py-2" style="height: 56px;">
                                            <span class="badge bg-light text-secondary border fw-normal">
                                                <i class="bi bi-hourglass"></i> Prix non communiqué
                                            </span>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top border-light text-muted" style="font-size: 0.65rem;">
                                    <span><i class="bi bi-calendar-event"></i> {{ a.date_vente_ts | format_datetime('%d/%m') }}</span>
                                    <span><i class="bi bi-clock"></i> {{ a.date_vente_ts | format_datetime('%H:%M') }}</span>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="col-12 text-center py-5">
                    <div class="text-muted display-1 opacity-25"><i class="bi bi-search"></i></div>
                    <h4 class="mt-3 text-dark">Aucun véhicule trouvé</h4>
                    <p class="text-muted">Essayez d'élargir vos critères de recherche.</p>
                </div>
                {% endfor %}
            </div>
            
            {% if total_pages > 1 %}
            <nav class="mt-5 d-flex justify-content-center">
                <ul class="pagination">
                    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                        <a class="page-link border bg-white text-dark mx-1 rounded" href="{{ url_for('index', page=current_page - 1) }}">Précédent</a>
                    </li>
                    <li class="page-item disabled"><span class="page-link border-0 bg-transparent">{{ current_page }} / {{ total_pages }}</span></li>
                    <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                        <a class="page-link border bg-white text-dark mx-1 rounded" href="{{ url_for('index', page=current_page + 1) }}">Suivant</a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Recherche Marques
        const searchInput = document.getElementById('marqueSearch');
        const listContainer = document.getElementById('marqueList');
        if (searchInput && listContainer) {
            searchInput.addEventListener('keyup', function() {
                const filter = this.value.toLowerCase();
                const items = listContainer.querySelectorAll('.form-check');
                items.forEach(function(item) {
                    const label = item.querySelector('label').textContent.toLowerCase();
                    item.style.display = label.includes(filter) ? "" : "none";
                });
            });
        }
    });

    // Fonction Globale pour Tout Cocher / Décocher
    function toggleCheckboxes(containerId, checkState) {
        const container = document.getElementById(containerId);
        if (container) {
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkState);
        }
    }
</script>
{% endblock %}