{% extends 'base.html' %}

{% block title %}Ventes √† Venir - AutoEnch√®res Pro{% endblock %}

{% block content %}
<style>
    /* --- CSS RESPONSIVE & SIDEBAR --- */
    
    /* Sur Desktop : Sidebar sticky classique */
    @media (min-width: 992px) {
        .sidebar-wrapper {
            position: sticky; 
            top: 5rem;
            height: calc(100vh - 6rem);
            overflow-y: auto;
            padding-right: 10px;
        }
        /* Masquer le header de l'offcanvas sur desktop */
        .offcanvas-header { display: none; }
    }

    /* Sur Mobile : Ajustements pour l'Offcanvas */
    @media (max-width: 991.98px) {
        .sidebar-wrapper {
            height: 100%; /* L'offcanvas g√®re le scroll */
            overflow-y: auto;
        }
        /* Ajustement du bouton flottant si besoin */
        .mobile-filter-btn {
            position: sticky;
            top: 70px; /* Juste sous la navbar */
            z-index: 99;
            margin-bottom: 1rem;
        }
    }

    /* Scrollbar fine */
    .sidebar-wrapper::-webkit-scrollbar, 
    .filter-list-scroll::-webkit-scrollbar { width: 4px; }
    .sidebar-wrapper::-webkit-scrollbar-thumb, 
    .filter-list-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

    .filter-group { background: #f8fafc; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 0.75rem; }
    .filter-title { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: #64748b; margin-bottom: 0.5rem; letter-spacing: 0.5px; }
    .filter-list-scroll { max-height: 150px; overflow-y: auto; }

    /* Carte V√©hicule */
    .card-vehicule { transition: all 0.2s; border: 1px solid #e2e8f0; background: white; }
    .card-vehicule:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
        border-color: var(--color-primary);
        z-index: 10;
    }
    .img-container { position: relative; height: 190px; overflow: hidden; background: #f1f5f9; border-bottom: 1px solid #f1f5f9; }
    .img-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .card-vehicule:hover .img-container img { transform: scale(1.05); }
    
    .stat-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.25rem; }
    .progress-thin { height: 6px; border-radius: 3px; background-color: #e2e8f0; }
    .info-tag { font-size: 0.7rem; background: #f1f5f9; color: #475569; padding: 2px 6px; border-radius: 4px; margin-right: 4px; display: inline-block; margin-bottom: 4px; border: 1px solid #e2e8f0; }
</style>

<div class="row g-0">
    
    <!-- BOUTON FILTRE MOBILE (Visible uniquement < lg) -->
    <div class="col-12 d-lg-none px-3 mobile-filter-btn">
        <button class="btn btn-primary w-100 shadow-sm fw-bold" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarFilters" aria-controls="sidebarFilters">
            <i class="bi bi-funnel-fill"></i> Filtrer les annonces
        </button>
    </div>

    <!-- SIDEBAR / OFFCANVAS -->
    <!-- Note: 'offcanvas-lg' permet de l'afficher comme une colonne normale sur grand √©cran -->
    <aside class="col-lg-3 col-xl-2 border-end bg-white">
        <div class="offcanvas-lg offcanvas-start bg-white h-100" tabindex="-1" id="sidebarFilters" aria-labelledby="sidebarFiltersLabel">
            
            <!-- Header Mobile (Croix de fermeture) -->
            <div class="offcanvas-header border-bottom">
                <h5 class="offcanvas-title fw-bold" id="sidebarFiltersLabel"><i class="bi bi-sliders"></i> Filtres</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#sidebarFilters" aria-label="Close"></button>
            </div>

            <!-- Contenu Sidebar -->
            <div class="offcanvas-body p-0">
                <div class="sidebar-wrapper ps-3 py-3 pe-3">
                    <form method="POST" action="{{ url_for('index') }}" id="filterForm">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0 text-dark d-none d-lg-block"><i class="bi bi-funnel-fill text-primary"></i> Filtres</h6>
                            <a href="{{ url_for('reset_filters') }}" class="text-danger small text-decoration-none fw-bold"><i class="bi bi-x"></i> Reset</a>
                        </div>

                        <!-- Recherche Texte -->
                        <div class="mb-3">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                                <input type="text" name="keyword" class="form-control border-start-0 bg-light" value="{{ f_keyword }}" placeholder="Mod√®le, mot-cl√©...">
                            </div>
                        </div>

                        <!-- DATES DE VENTE -->
                        <div class="filter-group">
                            <div class="filter-title">Date de vente</div>
                            <div class="row g-1">
                                <div class="col-6">
                                    <label class="form-label small text-muted mb-0" style="font-size: 0.65rem;">Du</label>
                                    <input type="date" name="date_min" class="form-control form-control-sm" value="{{ f_date_min }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label small text-muted mb-0" style="font-size: 0.65rem;">Au</label>
                                    <input type="date" name="date_max" class="form-control form-control-sm" value="{{ f_date_max }}">
                                </div>
                            </div>
                        </div>

                        <!-- Tri & ROI -->
                        <div class="filter-group border-primary border-opacity-25 bg-primary bg-opacity-10">
                            <div class="filter-title text-primary">Rentabilit√© & Tri</div>
                            <select name="sort" class="form-select form-select-sm mb-2 border-primary" onchange="this.form.submit()">
                                <option value="roi_desc" {% if f_sort == 'roi_desc' %}selected{% endif %}>üöÄ Rentabilit√© (%)</option>
                                <option value="marge_desc" {% if f_sort == 'marge_desc' %}selected{% endif %}>üí∞ Marge (‚Ç¨)</option>
                                <option value="date_vente_asc" {% if f_sort == 'date_vente_asc' %}selected{% endif %}>üìÖ Date (Proche)</option>
                                <option value="prix_asc" {% if f_sort == 'prix_asc' %}selected{% endif %}>‚Ç¨ Prix (Bas)</option>
                            </select>
                            <div class="row g-1">
                                <div class="col-6">
                                    <input type="number" name="marge_min" class="form-control form-control-sm" value="{{ f_marge_min }}" placeholder="Marge Min">
                                </div>
                                <div class="col-6">
                                    <input type="number" name="prix_max" class="form-control form-control-sm" value="{{ f_prix_max }}" placeholder="Budget Max">
                                </div>
                            </div>
                        </div>

                        <!-- MARQUES -->
                        <div class="filter-group">
                            <div class="filter-title">Marques</div>
                            <input type="text" id="marqueSearch" class="form-control form-control-sm mb-2" placeholder="Chercher une marque...">
                            <div class="filter-list-scroll" id="marqueList">
                                {% for m in marques %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="marque" value="{{ m }}" id="m-{{ loop.index }}" {% if m in f_marques %}checked{% endif %}>
                                    <label class="form-check-label small text-truncate w-100" for="m-{{ loop.index }}">{{ m }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- BOITES -->
                        <div class="filter-group">
                            <div class="filter-title">Bo√Æte de vitesse</div>
                            <div class="filter-list-scroll">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="boite" value="None" id="b-none" {% if 'None' in f_boites %}checked{% endif %}>
                                    <label class="form-check-label small text-muted fst-italic" for="b-none">Non sp√©cifi√©</label>
                                </div>
                                {% for b in boites %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="boite" value="{{ b }}" id="b-{{ loop.index }}" {% if b in f_boites %}checked{% endif %}>
                                    <label class="form-check-label small" for="b-{{ loop.index }}">{{ b }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- ENERGIE -->
                        <div class="filter-group">
                            <div class="filter-title">√ânergie</div>
                            <div class="filter-list-scroll" style="max-height: 100px;">
                                {% for e in energies %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="energie" value="{{ e }}" id="e-{{ loop.index }}" {% if e in f_energies %}checked{% endif %}>
                                    <label class="form-check-label small" for="e-{{ loop.index }}">{{ e }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- KM & ANNEE -->
                        <div class="filter-group">
                            <div class="filter-title">Compteur & Ann√©e</div>
                            <div class="mb-2">
                                <input type="number" name="km_max" class="form-control form-control-sm" value="{{ f_km_max }}" placeholder="KM Max (ex: 150000)">
                            </div>
                            <div class="row g-1">
                                <div class="col-6">
                                    <input type="number" name="annee_min" class="form-control form-control-sm" value="{{ f_annee_min }}" placeholder="An Min">
                                </div>
                                <div class="col-6">
                                    <input type="number" name="annee_max" class="form-control form-control-sm" value="{{ f_annee_max }}" placeholder="An Max">
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mt-3 mb-5">
                            <button type="submit" class="btn btn-primary btn-sm fw-bold shadow-sm">
                                <i class="bi bi-check-lg"></i> Appliquer les filtres
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="col-12 col-lg-9 col-xl-10 bg-light">
        <div class="p-3 p-md-4">
            <!-- Info Bar -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 bg-white p-3 rounded shadow-sm border">
                <div class="mb-3 mb-md-0">
                    <h5 class="fw-bold mb-0">{{ total_annonces }} <span class="text-muted fs-6 fw-normal">r√©sultats</span></h5>
                    {% if f_marques or f_keyword %}
                    <div class="mt-1">
                        {% for m in f_marques %} <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25">{{ m }}</span> {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- Pagination -->
                {% if total_pages > 1 %}
                <nav>
                    <ul class="pagination pagination-sm m-0">
                        <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                            <a class="page-link border-0 bg-transparent" href="{{ url_for('index', page=current_page - 1) }}"><i class="bi bi-chevron-left"></i></a>
                        </li>
                        <li class="page-item active"><span class="page-link border-0 fw-bold">{{ current_page }} <span class="fw-light text-muted">/ {{ total_pages }}</span></span></li>
                        <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                            <a class="page-link border-0 bg-transparent" href="{{ url_for('index', page=current_page + 1) }}"><i class="bi bi-chevron-right"></i></a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
            </div>

            <!-- GRILLE CARTES -->
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-3 g-xl-4">
                {% for a in annonces %}
                    {# Calcul ROI Template #}
                    {% set prix_total = a.prix_max_frais_inclus | default(0) | float %}
                    {% set marge = a.marge_estimee_min | default(0) | float %}
                    {% set roi = 0 %}
                    {% if prix_total > 0 %}
                        {% set roi = (marge / prix_total) * 100 %}
                    {% endif %}

                <div class="col">
                    <div class="card h-100 card-vehicule rounded-3 overflow-hidden">
                        <a href="{{ url_for('detail', annonce_id=a.id) }}" class="text-decoration-none text-dark">
                            <div class="img-container">
                                <img src="{{ a.lien_image_vehicule }}" loading="lazy" onerror="this.src='https://placehold.co/400x300?text=Image+Non+Dispo';">
                                
                                <!-- Badge ROI -->
                                {% if roi >= 20 %}
                                    <span class="position-absolute top-0 start-0 badge badge-roi-high m-2 shadow border border-white">
                                        <i class="bi bi-stars"></i> Top {{ roi | format_percent }}
                                    </span>
                                {% elif roi >= 10 %}
                                    <span class="position-absolute top-0 start-0 badge badge-roi-med m-2 shadow border border-white">
                                        <i class="bi bi-check-lg"></i> {{ roi | format_percent }}
                                    </span>
                                {% endif %}
                                
                                <span class="position-absolute bottom-0 end-0 badge bg-dark bg-opacity-75 backdrop-blur m-2 small">
                                    {{ a.maison_vente }}
                                </span>
                            </div>

                            <div class="card-body p-3 d-flex flex-column">
                                <h6 class="card-title fw-bold text-truncate mb-2" title="{{ a.titre_annonce }}">
                                    {{ a.titre_annonce }}
                                </h6>
                                
                                <!-- Donn√©es enrichies -->
                                <div class="mb-3">
                                    <div>
                                        <span class="info-tag">{{ a.annee }}</span>
                                        <span class="info-tag">{{ a.kilometrage | format_number }} km</span>
                                    </div>
                                    <div>
                                        <span class="info-tag text-truncate" style="max-width: 80px;">{{ a.energie }}</span>
                                        {% if a.boite_de_vitesse %}
                                            <span class="info-tag">{{ a.boite_de_vitesse }}</span>
                                        {% endif %}
                                    </div>
                                    {% if a.ville %}
                                    <div class="small text-muted mt-1 text-truncate">
                                        <i class="bi bi-geo-alt-fill text-danger opacity-50"></i> {{ a.ville }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Bloc Financier -->
                                <div class="mt-auto bg-light border rounded p-2 position-relative overflow-hidden">
                                    <div class="stat-row">
                                        <span class="text-muted">Investissement</span>
                                        <span class="fw-bold">{{ prix_total | format_number }} ‚Ç¨</span>
                                    </div>
                                    <div class="stat-row">
                                        <span class="text-muted">Marge Est.</span>
                                        <span class="fw-bold {% if roi > 10 %}text-success{% elif roi > 0 %}text-primary{% else %}text-danger{% endif %}">
                                            {% if marge > 0 %}+{% endif %}{{ marge | format_number }} ‚Ç¨
                                        </span>
                                    </div>
                                    
                                    <!-- Barre visuelle -->
                                    <div class="progress progress-thin mt-2 bg-white">
                                        {% set width = roi if roi < 100 else 100 %}
                                        {% set width = width if width > 0 else 5 %}
                                        <div class="progress-bar {% if roi > 15 %}bg-success{% elif roi > 5 %}bg-warning{% else %}bg-danger{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ width }}%"></div>
                                    </div>
                                </div>
                                
                                <div class="text-end mt-2">
                                    <small class="text-muted fst-italic" style="font-size: 0.7rem;">
                                        Vente le {{ a.date_vente_ts | format_datetime('%d/%m') }}
                                    </small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="col-12 text-center py-5">
                    <div class="text-muted display-1"><i class="bi bi-search"></i></div>
                    <h4 class="mt-3">Aucun v√©hicule trouv√©</h4>
                    <p class="text-muted">Essayez d'√©largir vos crit√®res de recherche.</p>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination Bas -->
            {% if total_pages > 1 %}
            <nav class="mt-5 d-flex justify-content-center">
                <ul class="pagination">
                    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('index', page=current_page - 1) }}">Pr√©c√©dent</a>
                    </li>
                    <li class="page-item active"><span class="page-link">{{ current_page }}</span></li>
                    <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('index', page=current_page + 1) }}">Suivant</a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Recherche rapide dans la liste des marques (JS pur)
        const searchInput = document.getElementById('marqueSearch');
        const listContainer = document.getElementById('marqueList');
        
        if (searchInput && listContainer) {
            searchInput.addEventListener('keyup', function() {
                const filter = this.value.toLowerCase();
                const items = listContainer.querySelectorAll('.form-check');
                
                items.forEach(function(item) {
                    const label = item.querySelector('label').textContent.toLowerCase();
                    if (label.includes(filter)) {
                        item.style.display = "";
                    } else {
                        item.style.display = "none";
                    }
                });
            });
        }
    });
</script>
{% endblock %}